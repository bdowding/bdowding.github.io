<!DOCTYPE html>
<html>
	<head>
		<title>Learn Parking</title>
		<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
		<meta content="utf-8" http-equiv="encoding">
		<script type="text/javascript" src="easeljs.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
	</head>
	<script>
		let _stage = null;
		let _car = null;
		let _updates = [];
		let _background = null;
		
		let wheelWidth = 10;
		let wheelHeight = 20;
			
			
		function clamp(num, min, max) {
			return num <= min ? min : num >= max ? max : num;
		}
		
		var _pressedKeys = {
			left: false,
			right: false,
			up: false,
			down: false,
			space: false,
		}
		
		var keyMap = {
			68: 'right', 39: 'right',
			65: 'left', 37: 'left', 
			87: 'up', 38: 'up',
			83: 'down', 40: 'down',
			32: 'space',
		}
		function keydown(event) {
			var key = keyMap[event.keyCode]
			if (key !== undefined) {
				_pressedKeys[key] = true;
				event.preventDefault();
			}
		}
		function keyup(event) {
			var key = keyMap[event.keyCode]
			_pressedKeys[key] = false
		}
		
		window.addEventListener("keydown", keydown, false)
		window.addEventListener("keyup", keyup, false)
		
		function updateWheel(w) {
			let pos = w.localToGlobal(wheelWidth / 2, wheelHeight / 2);
			
			if (w.positions === undefined) {
				w.positions = [];
			}
			
			if (w.positions.length < 2) {
				w.positions.push({ x: pos.x, y: pos.y });
				w.penCanvas.graphics.clear();
				return;
			}
			
			let oldPos = w.positions[w.positions.length - 1];
			if (Math.abs(oldPos.x - pos.x) + Math.abs(oldPos.y - pos.y) < 4) {
				return;
			}
			
			w.positions.push({ x: pos.x, y: pos.y });
			
			// Draw from last pos to here
			let line = w.penCanvas.graphics
				.clear()
				.setStrokeStyle(2, 'round', 'round')
				.beginStroke("Red")
				.moveTo(w.positions[0].x, w.positions[0].y);
				
			for (let i in w.positions) {
				let p = w.positions[i];
				line.lineTo(p.x, p.y);
			}
			while (w.positions.length > 500) {
				w.positions.shift();
			}
		}
		
		function init() {
			_stage = new createjs.Stage("demoCanvas");
			_background = new createjs.Bitmap("roads.png");
			_background.scaleX = 0.8;
			_background.scaleY = 0.8
			_stage.addChild(_background);
			_car = new createjs.Container();
			_car.x = 100;
			_car.y = 180;
			_car.theta = Math.PI / 2;
			_car.steerTheta = 0;
			_car.activeWheels = [];
			_car.wheels = [];
			_car.carLength = 80;
			_car.speed = 0;
			
			//let carBody = new createjs.Shape();
			//carBody.graphics.beginFill("DeepSkyBlue").drawRect(-25, -((_car.carLength + 25) / 2), 50, _car.carLength + 25);
			
			carBody = new createjs.Bitmap("car.png");
			carBody.scaleX = 0.7;
			carBody.scaleY = 0.68;
			carBody.x = -40;
			carBody.y = -57;
			_car.addChild(carBody);
			_car.regY = _car.carLength * 0.5;
			
			let wheels = [
				[ -21, -_car.carLength / 2, true ],
				[ 21, -_car.carLength / 2, true ],
				[ -21, _car.carLength / 2, false ],
				[ 21, _car.carLength / 2, false ],
			];
			
			for (let i in wheels) {				
				let wheel = new createjs.Shape();
				let active = wheels[i][2];
				wheel.graphics.beginFill("Grey").drawRect(0, 0, 10, 20);
				wheel.regX = wheelWidth / 2;
				wheel.regY = wheelHeight / 2;
				wheel.x = wheels[i][0];
				wheel.y = wheels[i][1];
				_car.addChild(wheel);
				if (active) {
					_car.activeWheels.push(wheel);
				}
				_car.wheels.push(wheel);
				_updates.push(() => { updateWheel(wheel); });				
				wheel.penCanvas = new createjs.Shape();
				_stage.addChild(wheel.penCanvas);
			}
			

			_stage.addChild(_car);
			_stage.update();
			window.requestAnimationFrame(loop);
			
			let btns = $("button");
			let press = (e) => { let k = $(e.currentTarget).attr("btnKey"); _pressedKeys[k] = true; console.log(k, "press"); };
			let release = (e) => { let k = $(e.currentTarget).attr("btnKey"); _pressedKeys[k] = false; console.log(k, "release"); };
			btns.on("mousedown", press);
			btns.on("mouseup", release);
			btns.on("mouseleave", release);
			btns.on("touchstart", press);
			btns.on("touchend", release);
			btns.on("touchcancel", release);
		}
		
		function update(progress) {
			// Update the state of the world for the elapsed time since last render
			if (_pressedKeys.space) {
				for (let i in _car.wheels) {
					_car.wheels[i].positions = [];
				}
			}
			if (_pressedKeys.left) {
				_car.steerTheta -= 0.02;
			}
			if (_pressedKeys.right) {
				_car.steerTheta += 0.02;
			}
			
			_car.steerTheta = clamp(_car.steerTheta, -0.3 * Math.PI, 0.3 * Math.PI);
			let delta = 0;
			if (_pressedKeys.up) {
				delta += 1;
			}
			if (_pressedKeys.down) {
				delta -= 1;
			}
			for (let i in _car.activeWheels) {
				_car.activeWheels[i].rotation = _car.steerTheta * 180 / Math.PI;
			}
			
			_car.speed += delta * 0.1;
			
			let fwdMovement = _car.speed * Math.cos(_car.steerTheta);
			let sideMovement = _car.speed * Math.sin(_car.steerTheta);
			let thetaChange = Math.atan(sideMovement / _car.carLength);
			_car.theta += thetaChange;
			_car.x += Math.sin(_car.theta) * fwdMovement;
			_car.y -= Math.cos(_car.theta) * fwdMovement;
			
			_car.rotation = _car.theta * 180 / Math.PI;
			_car.speed *= 0.9;
			
			for (let i in _updates) {
				_updates[i]();
			}
		}
		
		function draw() {
			// Draw the state of the world
			_stage.update();
		}
		
		function loop(timestamp) {
			var progress = timestamp - lastRender
			
			update(progress)
			draw()
			
			lastRender = timestamp
			window.requestAnimationFrame(loop)
		}
		
		var lastRender = 0
		
		window.onload = init;
	</script>
	<body style="background:#eee;">
		<div>
			<canvas id="demoCanvas" width="1200" height="800"></canvas>
		</div>
		<div>
			<style>
				button { width: 5em; height: 5em; font-size: 30pt; 
				    -webkit-touch-callout: none;
					-webkit-user-select: none;
					-khtml-user-select: none;
					-moz-user-select: none;
					-ms-user-select: none;
					user-select: none;
					touch-action: manipulation;
				}
			</style>
			<div style="display:inline-block;vertical-align:top;margin-left:5em;">
				<button btnKey="up" style="display:block;">&uarr;</button>
				<button btnKey="down" style="display:block;">&darr;</button>			
			</div>
			<div style="display:inline-block;vertical-align:top;margin-left:5em;">
				<button btnKey="left">&larr;</button>
				<button btnKey="right">&rarr;</button>
			</div>
			<div style="margin:5em;">
				<button btnKey="space">Clear tracks</button>
			</div>
		</div>
	</body>
</html>